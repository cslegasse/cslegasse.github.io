<!DOCTYPE html>
<html>
  <head>
    <title>Experiment Template</title>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-html-form.js"></script>
    <script src="aws-sdk-2.701.0.min.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>Please wait while the experiment loads. If you continue to see this page, you may be experiencing an internet connectivity issue or our server may be overloaded with requests. Please wait a few more seconds while we continue loading the experiment data. If you see this page for longer than one minute, please try refreshing the page, or closing and re-opening your web browser.</body>
  <script>
      
        async function getObjectData(seed) {
            return fetch('https://tylergiallanza.github.io/mturk-experiments/seed_data/'+seed+'_200_objects.json').then(response => response.json()).then(jsonResponse => {return jsonResponse});
        }
        
        async function getFeatureData(seed) {
            return fetch('https://tylergiallanza.github.io/mturk-experiments/seed_data/'+seed+'_200_features.json').then(response => response.json()).then(jsonResponse => {return jsonResponse});
        }
      async function startJsPsych() {

        
        var MAX_TRIALS = 100;
        var seed_list = [120];
        stimulus_idx = 0;
        var metadata = {};
        var random_code = Math.floor(Math.random()*1000000).toString(36);
        var seed = seed_list[Math.floor(Math.random()*seed_list.length)];

        //stimulus_list = stimulus_list[seed];
        //feature_list = feature_list[seed];
        const stimulus_list = await this.getObjectData(seed);
        var feature_list = await this.getFeatureData(seed);
        
        function shuffle(array) {
            let currentIndex = array.length,  randomIndex;

            // While there remain elements to shuffle...
            while (currentIndex != 0) {

                // Pick a remaining element...
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;

                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }

            return array;
        }
        timeline = [];
        var informed_consent_msg = "Psychology Experiment - Informed Consent Form<br>You have been invited to take part in a research study.<br>TITLE OF RESEARCH: Dual-Task Semantic Judgements<br>INVESTIGATOR: Jonathan Cohen, Tyler Giallanza \
        <br><br>The following informed consent is required by Princeton University for any person involved in a research study conducted by investigators at the University. This study has been approved by the University's Institutional Review Board for Human Subjects. \
        <br><br>You will be asked to make judgements about objects. The study will take 5-8 minutes to complete and \
        you will be rewarded $1.40 for your participation. You can complete this survey multiple times, conditional on continuing to have good performance.</b><br><br><br> \
        <b>If you have any questions about this study, your payment, or the research being conducted, you may contact the research team at tylerg.research.experiments@gmail.com.</b> If you have questions regarding your rights as a research subject, or if problems arise which you do not feel you can discuss with the Investigator, please contact the Institutional Review Board at:<br> Office of Research Integrity and Assurance<br>Compliance Administrator<br>Phone: (609) 258-0865<br>Email: irb@princeton.edu<br><br> \
        By continuing with the study, you affirm that: Your participation is voluntary, and you may withdraw your consent and discontinue participation in the project at any time. Your refusal to participate will not result in any penalty. \
        By signing this agreement, you do not waive any legal rights or release Princeton University, its agents, or you from liability for negligence. There may be no direct benefit to you from participation in this study other than the monetary payment as described above, though there may be indirect benefits as a result of what we learn about the human mind from your participation. The information obtained from this study will be confidential. It will be available to the investigators performing the study. Your worker ID will be anonymized and your identity will remain anonymous in any publications resulting from this study. You are a legal adult at your jurisdiction. This means you are 21 or older if you are in Mississippi; 19 or older if you are in Alabama, Delaware, and Nebraska; 18 or older in another state, or an emancipated minor according to your local laws. This document and/or additional email communication with the investigators answered any questions that you have regarding the study. <br><br> \
        If you understand and consent to these terms, press 'j' to continue with the experiment.";
        var welcome = {
        type: "html-keyboard-response",
        stimulus: informed_consent_msg,
        choices: ['j']
        };

        var instructions = {
            type: "html-keyboard-response",
            stimulus: "In this experiment, you will repeatedly be presented with an object and a property.<br>For example: object=dog, property=has ears.<br><br>\
                        We would like you to indicate if the property tends to be true of the object. \
                        For example, if the object is 'dog' and the property is 'has ears', you should indicate that the property is true. \
                        If the property is subjective, try to consider what most people would think. For example, 'cute' is a true property for 'dog'.\
                        If the property is only sometimes true, you should indicate that the property is true. For example, 'brown' and 'white' are true properties for 'dog', but 'purple' is not.\
                        <br><br> \
                        <b>If the property is true, press 'j' on your keyboard. If the property is false, press 'f'.</b>\
                        <br><br>\
                       During the experiment, you may be presented a word that you don't know or a property that does not make sense. You are allowed to skip these words by pressing the space bar. \
                       When you skip a word we will give you a new word, so skipping a word will not make the experiment shorter. \
                       <br><br> \
                       Press 'j' to begin the experiment.",
            choices: ['j'],
            data: {show_stims:true, skipped:false, trials_done:0, stimval:''}
        }

        var make_trial = function(p) {
            var trial = {
                timeline:[{
                    type: "html-keyboard-response",
                    stimulus: function() {
                        return '<p style="font-size:26pt;">Object: '+jsPsych.timelineVariable('stimulus',true)+'</p><p style="font-size:26pt;">Property: '+jsPsych.timelineVariable('feature',true)+'</p>';
                    },
                    choices: ['f','j',' '],
                    on_finish: function(data) {
                        var l = jsPsych.data.get().last(2).values()[0];
                        data.finished_counter = l.finished_counter;
                        if(data.key_press==32) {
                            data.skipped = true;
                        } else {
                            data.skipped = false;
                        }
                        if(data.skipped) {
                            data.trials_done = l.trials_done;
                        } else {
                            data.trials_done = l.trials_done+1;
                        }
                    }
                }],
                conditional_function: function() {
                    l = jsPsych.data.get().last(1).values()[0];
                    if(l.trials_done > MAX_TRIALS) {
                        return false;
                    }
                    return true;
                }
            }
            return trial;
        }

        var make_trial_set = function() {
            var t = [make_trial()];
            //var t = [make_trial('Please list features of the word above, one per line. If you do not know what this word means, type "skip".')];
            //stimulus_list = shuffle(stimulus_list);
            //feature_list = shuffle(feature_list);
            console.log(stimulus_list);
            console.log(stimulus_idx);
            var s = stimulus_list[stimulus_idx].replaceAll('_',' ');
            var f = feature_list[stimulus_idx];
            stimulus_idx++;
            var trial_set = {
                timeline: t,
                timeline_variables: [{stimulus: s, feature: f}],
                data: {stimulus:s, feature: f}
            }
            return trial_set
        }

        block_timeline = []
        for(var i=0;i<150;i++) {
            block_timeline.push(make_trial_set());
        }
        var block = {
            timeline:  block_timeline
        }

        var exit = {
            timeline:[
                {
                type: "survey-html-form",
                preamble: "You have completed all of the tasks. Please enter the following information. Note that the mturk worker id is required for being invited to the next experiment.",
                html: "Gender: <input name='gender' type='text' /><br>Age: <input name='age' type='num' /><br> \
                        Worker ID (optional): <input name='workerid' type='text' /><br> \
                        Comments (optional): <input name='comments' type='text' />",
                on_finish: function(data) {handle_close(data)} 
                },
                {
                    type: "html-keyboard-response",
                    stimulus: "Thank you for your participation.<br><br>Your survey validation code is qr2-1g3-13c-" + random_code + ".<br><br> \
                    If you have any concerns about payment, please contact <b>tylerg.research.experiments@gmail.com</b> with any questions.",
                    choices: jsPsych.NO_KEYS
                }
            ],

        }

        let bucket_name = "bhv-feature-verification";
        let aws_success = 0;
        AWS.config.region = 'us-east-1';
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: 'us-east-1:0284783b-226e-4f9c-ad9e-bc1b553e5347',
        });
        var do_upload = function(s3,params) {
            s3.upload(params, function(err,data) {
                if(err){
                console.log(err,err.stack);
                } else {
                console.log('success');
                aws_success++;
                }
            });
        }
        var uploadS3 = function(id, metadata, data, blob) {
            var s3 = new AWS.S3({params:{Bucket:bucket_name}});
            var params = {
                Bucket: bucket_name,
                Key: id+'_STpilot-audio',
                Body: blob
            };
            const first_part = parseInt(Math.random()*10000).toString();
            const second_part = parseInt(Math.random()*10000).toString();
            const third_part = parseInt(Math.random()*10000).toString();
            var randval = first_part+'-'+second_part+'-'+third_part;
            params.Key = id+'_pilot-metadata_'+randval;
            params.Body = metadata;
            do_upload(s3,params);
            params.Key = id+'_pilot-data_'+randval;
            params.Body = data;
            do_upload(s3,params);
        };

        var handle_close = function(data){
            participantID = JSON.parse(jsPsych.data.get().last(1).values()[0].responses).workerid;
            metadata.participantid = participantID;
            metadata.code = random_code;
            metadata.seed = seed;
            if(!participantID.length) {
                const first_part = parseInt(Math.random()*10000).toString();
                const second_part = parseInt(Math.random()*10000).toString();
                const third_part = parseInt(Math.random()*10000).toString();
                participantID = first_part+'-'+second_part+'-'+third_part;
                metadata.participantid = participantID;
            }
            uploadS3(participantID,JSON.stringify(metadata),jsPsych.data.get().json(),'');
            console.log('hc!');
            console.log('set shouldStop to true.');
            console.log(jsPsych.data.get().json());
        }

        timeline.push(welcome);
        timeline.push(instructions);
        timeline.push(block);
        timeline.push(exit);

        jsPsych.init({
            timeline: timeline,
            exclusions: {
                min_width: 100,
                min_height: 200
            }
        });
      }
      window.onbeforeunload = function() {
        return "Are you sure you want to refresh? You will lose your progress on this task.";
      };
      startJsPsych();
  </script>
</html>
