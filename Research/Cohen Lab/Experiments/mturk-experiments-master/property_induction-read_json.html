<!DOCTYPE html>
<html>
  <head>
    <title>Experiment</title>
    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-survey-html-form.js"></script>
    <script src="aws-sdk-2.701.0.min.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body>Please wait while the experiment loads. If you continue to see this page, you may be experiencing an internet connectivity issue or our server may be overloaded with requests. Please wait a few more seconds while we continue loading the experiment data. If you see this page for longer than one minute, please try refreshing the page, or closing and re-opening your web browser.</body>
  <script>
        function shuffle(array) {
            let currentIndex = array.length,  randomIndex;

            // While there remain elements to shuffle.
            while (currentIndex > 0) {

                // Pick a remaining element.
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;

                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
            }

            return array;
        }
        async function getObjectData() {
            return fetch('https://bhv-induction.s3.amazonaws.com/asym_similarity.json').then(response => response.json()).then(jsonResponse => {return jsonResponse});
        }

      async function startJsPsych() {      
        var N_ARG_PAIRS = 35;
        stimulus_idx = 0;
        var metadata = {};
        var random_code = Math.floor(Math.random()*1000000).toString(36);
        arg_list_full = await getObjectData();
        shuffle(arg_list_full);
        var arg_list = arg_list_full.slice(0,N_ARG_PAIRS);
        arg_list.push({'Argument 1-Premise 1':'Turkeys','Argument 1-Premise 2':'','Argument 1-Conclusion':'Turkeys','Argument 2-Premise 1':'Turkeys','Argument 2-Premise 2':'','Argument 2-Conclusion':'Storks'});
        arg_list.push({'Argument 1-Premise 1':'Cows','Argument 1-Premise 2':'','Argument 1-Conclusion':'Cows','Argument 2-Premise 1':'Cows','Argument 2-Premise 2':'','Argument 2-Conclusion':'Salmon'});
        arg_list.push({'Argument 1-Premise 1':'Salmon','Argument 1-Premise 2':'','Argument 1-Conclusion':'Salmon','Argument 2-Premise 1':'Salmon','Argument 2-Premise 2':'','Argument 2-Conclusion':'Cows'});
        arg_list.push({'Argument 1-Premise 1':'Pigs','Argument 1-Premise 2':'','Argument 1-Conclusion':'Pigs','Argument 2-Premise 1':'Pigs','Argument 2-Premise 2':'','Argument 2-Conclusion':'Rats'});
        arg_list.push({'Argument 1-Premise 1':'Mice','Argument 1-Premise 2':'','Argument 1-Conclusion':'Mice','Argument 2-Premise 1':'Mice','Argument 2-Premise 2':'','Argument 2-Conclusion':'Bats'});
        shuffle(arg_list);
        // Add a value called "flipped" to each item in arg list, which is a boolean that's randomly true or false
        arg_list.forEach(function(d) {
            d.flipped = Math.random() > 0.5;
        });

        timeline = [];
        var informed_consent_msg = "Psychology Experiment - Informed Consent Form<br>You have been invited to take part in a research study.<br>TITLE OF RESEARCH: Semantic Judgements<br>INVESTIGATOR: Jonathan Cohen, Tyler Giallanza \
        <br><br>The following informed consent is required by Princeton University for any person involved in a research study conducted by investigators at the University. This study has been approved by the University's Institutional Review Board for Human Subjects. \
        <br><br>You will be asked to make judgements about objects. The study will take 5-7 minutes to complete and \
        you will be rewarded $1.20 for your participation. You can complete this survey multiple times, conditional on continuing to have good performance.</b><br><br><br> \
        <b>If you have any questions about this study, your payment, or the research being conducted, you may contact the research team at tylerg.research.experiments@gmail.com.</b> If you have questions regarding your rights as a research subject, or if problems arise which you do not feel you can discuss with the Investigator, please contact the Institutional Review Board at:<br> Office of Research Integrity and Assurance<br>Compliance Administrator<br>Phone: (609) 258-0865<br>Email: irb@princeton.edu<br><br> \
        By continuing with the study, you affirm that: Your participation is voluntary, and you may withdraw your consent and discontinue participation in the project at any time. Your refusal to participate will not result in any penalty. \
        By signing this agreement, you do not waive any legal rights or release Princeton University, its agents, or you from liability for negligence. There may be no direct benefit to you from participation in this study other than the monetary payment as described above, though there may be indirect benefits as a result of what we learn about the human mind from your participation. The information obtained from this study will be confidential. It will be available to the investigators performing the study. Your worker ID will be anonymized and your identity will remain anonymous in any publications resulting from this study. You are a legal adult at your jurisdiction. This means you are 21 or older if you are in Mississippi; 19 or older if you are in Alabama, Delaware, and Nebraska; 18 or older in another state, or an emancipated minor according to your local laws. This document and/or additional email communication with the investigators answered any questions that you have regarding the study. <br><br> \
        If you understand and consent to these terms, press 'j' to continue with the experiment.";
        var welcome = {
        type: "html-keyboard-response",
        stimulus: informed_consent_msg,
        choices: ['j']
        };

        var instructions = {
            type: "html-keyboard-response",
            stimulus: `In this experiment, you will be asked to evaluate statements about the similarity between objects.
                       You will be presented with two similarity statements and asked to decide which statement seems stronger.<br>
                       For example, consider the following:<br>
                       <div style="display:block;font-size:24pt;">
                        <p>Which of the two statements seems stronger?</p>
                        <div style="display:inline-block;margin-right:5rem;max-width:25%">
                            <u>Ponies</u> are like <u>Horses</u>.
                        </div>
                        <div style="display:inline-block;margin-right:5rem;max-width:25%">
                            <u>Horses</u> are like <u>Ponies</u>.
                        </div>  
                      </div><br>
            
                      You will be asked a series of questions like this.
                      There is no "right answer" to these questions; we are interested in your opinion about which statement seems stronger.
                      If you believe the statement on the left is stronger, press 'f'. If you believe the statement on the right is stronger, press 'j'.<br><br>
                      To ensure you are paying attention, a small number of trials <i>will</i> have an obvious correct answer.
                      For example: "Are horses more like ponies, or are horses more like horses?"<br><br>
                        Press 'j' to begin the experiment.`,
            choices: ['j']
        }

        var make_trial = function(p) {
            var trial = {
                timeline:[{
                    type: "html-keyboard-response",
                    stimulus: function() {
                        // By default, the second argument is the strong argument
                        if (jsPsych.timelineVariable('flipped',true)) {
                            // When flipped, the first argument is the strong argument
                            var a1p1 = jsPsych.timelineVariable('Argument 2-Premise 1',true);
                            var a1p2 = jsPsych.timelineVariable('Argument 2-Premise 2',true);
                            var a1c = jsPsych.timelineVariable('Argument 2-Conclusion',true);
                            var a2p1 = jsPsych.timelineVariable('Argument 1-Premise 1',true);
                            var a2p2 = jsPsych.timelineVariable('Argument 1-Premise 2',true);
                            var a2c = jsPsych.timelineVariable('Argument 1-Conclusion',true);
                        } else {
                            var a1p1 = jsPsych.timelineVariable('Argument 1-Premise 1',true);
                            var a1p2 = jsPsych.timelineVariable('Argument 1-Premise 2',true);
                            var a1c = jsPsych.timelineVariable('Argument 1-Conclusion',true);
                            var a2p1 = jsPsych.timelineVariable('Argument 2-Premise 1',true);
                            var a2p2 = jsPsych.timelineVariable('Argument 2-Premise 2',true);
                            var a2c = jsPsych.timelineVariable('Argument 2-Conclusion',true);
                        }
                        return `
                        <div style="display:block;font-size:24pt;">
                        <p>Which of the two statements seems stronger?</p>
                        <div style="display:inline-block;margin-right:5rem;max-width:25%">
                            <u>`+a1p1+`</u> are like <u>`+a1c+`</u>.
                        </div>
                        <div style="display:inline-block;margin-right:5rem;max-width:25%">
                            <u>`+a2p1+`</u> are like <u>`+a2c+`</u>.
                        </div>  
                      </div>`      
                    },
                    choices: ['f','j'],
                    data: {
                        'Argument 1-Premise 1': jsPsych.timelineVariable('Argument 1-Premise 1'),
                        'Argument 1-Premise 2': jsPsych.timelineVariable('Argument 1-Premise 2'),
                        'Argument 1-Conclusion': jsPsych.timelineVariable('Argument 1-Conclusion'),
                        'Argument 2-Premise 1': jsPsych.timelineVariable('Argument 2-Premise 1'),
                        'Argument 2-Premise 2': jsPsych.timelineVariable('Argument 2-Premise 2'),
                        'Argument 2-Conclusion': jsPsych.timelineVariable('Argument 2-Conclusion'),
                        'Strong Argument First': jsPsych.timelineVariable('flipped'),
                    }
                }],
            }
            return trial;
        }

        var make_trial_set = function() {
            var t = [make_trial()];
            var trial_set = {
                timeline: t,
                timeline_variables: arg_list
            }
            return trial_set
        }

        block_timeline = []
        block_timeline.push(make_trial_set());
        var block = {
            timeline:  block_timeline
        }

        var exit = {
            timeline:[
                {
                type: "survey-html-form",
                preamble: "You have completed all of the tasks. Please enter the following information.",
                html: "Gender: <input name='gender' type='text' /><br> \
                        Age: <input name='age' type='num' /><br> \
                        Worker ID: <input name='workerid' type='text' /><br> \
                        Comments (optional): <input name='comments' type='text' />",
                on_finish: function(data) {handle_close(data)} 
                },
                {
                    type: "html-keyboard-response",
                    stimulus: "Thank you for your participation.<br><br>Your survey validation code is qr2-1g3-13c-" + random_code + ".<br><br> \
                    If you have any concerns about payment, please contact <b>tylerg.research.experiments@gmail.com</b> with any questions.",
                    choices: jsPsych.NO_KEYS
                }
            ],

        }

        let bucket_name = "bhv-induction";
        let aws_success = 0;
        AWS.config.region = 'us-east-1';
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: 'us-east-1:0284783b-226e-4f9c-ad9e-bc1b553e5347',
        });
        var s3 = new AWS.S3({params:{Bucket:bucket_name}});
        var do_upload = function(s3,params) {
            s3.upload(params, function(err,data) {
                if(err){
                console.log(err,err.stack);
                } else {
                console.log('success');
                aws_success++;
                }
            });
        }
        var uploadS3 = function(id, metadata, data, blob) {
            var params = {
                Bucket: bucket_name,
                Key: id+'_STpilot-audio',
                Body: blob
            };
            const first_part = parseInt(Math.random()*10000).toString();
            const second_part = parseInt(Math.random()*10000).toString();
            const third_part = parseInt(Math.random()*10000).toString();
            var randval = first_part+'-'+second_part+'-'+third_part;
            params.Key = id+'_pilot-metadata-asymsim_'+randval;
            params.Body = metadata;
            do_upload(s3,params);
            params.Key = id+'_pilot-data-asymsim_'+randval;
            params.Body = data;
            do_upload(s3,params);
        };

        var handle_close = function(data){
            participantID = JSON.parse(jsPsych.data.get().last(1).values()[0].responses).workerid;
            metadata.participantid = participantID;
            metadata.code = random_code;
            if(!participantID.length) {
                const first_part = parseInt(Math.random()*10000).toString();
                const second_part = parseInt(Math.random()*10000).toString();
                const third_part = parseInt(Math.random()*10000).toString();
                participantID = first_part+'-'+second_part+'-'+third_part;
                metadata.participantid = participantID;
            }
            uploadS3(participantID,JSON.stringify(metadata),jsPsych.data.get().json(),'');
            console.log(jsPsych.data.get().json());
        }

        timeline.push(welcome);
        timeline.push(instructions);
        timeline.push(block);
        timeline.push(exit);

        jsPsych.init({
            timeline: timeline,
            exclusions: {
                min_width: 100,
                min_height: 200
            }
        });
      }
      window.onbeforeunload = function() {
        return "Are you sure you want to refresh? You will lose your progress on this task.";
      };
      startJsPsych();
  </script>
</html>
